<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchly - Auto Backup</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Watchly</div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="leaderboard.html" class="nav-link">Leaderboard</a>
            <a href="backup.html" class="nav-link">Backup</a>
            <a href="guide.html" class="nav-link">Guide</a>
        </div>
    </nav>
    
    <div class="container">
        <header>
            <h1>Auto Backup Status</h1>
            <p>Monitor your automatic backup system</p>
        </header>

        <main>
            <div class="backup-container">
                <div class="status-card">
                    <h3>Backup Status</h3>
                    <div class="status-indicator" id="backupStatus">Not Configured</div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <h4>API Key</h4>
                        <div id="apiKeyStatus">Not Set</div>
                        <button id="setupApiKey" class="add-btn">Setup API Key</button>
                        <button id="removeApiKey" class="delete-btn" style="display:none; margin-top:10px;">Remove API Key</button>
                    </div>



                    <div class="info-card">
                        <h4>Last Backup</h4>
                        <div id="lastBackupTime">Never</div>
                    </div>

                    <div class="info-card">
                        <h4>Changes Since Backup</h4>
                        <div id="changesSince">No changes</div>
                    </div>

                    <div class="info-card extra-wide-card">
                        <h4>Next Backup</h4>
                        <div id="nextBackup">N/A</div>
                    </div>
                </div>

                <div class="actions">
                    <button id="forceBackup" class="add-btn">Force Backup Now</button>
                    <button id="testConnection" class="add-btn">Test Connection</button>
                </div>
            </div>
        </main>
    </div>

    <!-- API Key Setup Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Setup Auto Backup</h2>
            <p>Get your free API key from <a href="https://jsonbin.io" target="_blank" style="color: #ffffff;">jsonbin.io</a></p>
            <input type="text" id="apiKeyInput" placeholder="Enter your JSONBin.io API key">
            <div class="modal-actions">
                <button id="confirmApiKey" class="delete-btn">Save</button>
                <button id="cancelApiKey" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Status Message Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="statusTitle">Status</h2>
            <p id="statusMessage"></p>
            <div class="modal-actions">
                <button id="statusOk" class="delete-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Remove API Key Confirmation Modal -->
    <div id="removeApiKeyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Remove API Key</h2>
            <p>This will disable auto backup. You can add a new API key anytime.</p>
            <div class="modal-actions">
                <button id="confirmRemoveApiKey" class="delete-btn">Remove</button>
                <button id="cancelRemoveApiKey" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <style>
        .backup-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .status-card {
            background: linear-gradient(135deg, #404040, #000000);
            border: 2px solid #7f7f7f;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .status-indicator {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 10px;
            padding: 10px 20px;
            border-radius: 8px;
        }

        .status-active {
            background: #28a745;
            color: #ffffff;
        }

        .status-inactive {
            background: #dc3545;
            color: #ffffff;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #404040, #000000);
            border: 2px solid #7f7f7f;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .wide-card {
            grid-column: span 2;
        }

        .extra-wide-card {
            grid-column: span 3;
        }

        .info-card h4 {
            margin-bottom: 10px;
            color: #bfbfbf;
        }

        .info-card div {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .actions button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #7f7f7f, #404040);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }
    </style>

    <script>
        function updateBackupStatus() {
            const apiKey = localStorage.getItem('jsonbinApiKey');
            const lastBackup = localStorage.getItem('lastAutoBackup');
            const dataChanged = localStorage.getItem('dataChanged');
            const apiKeyValid = localStorage.getItem('apiKeyValid');

            // API Key Status
            if (apiKey) {
                document.getElementById('removeApiKey').style.display = 'block';
                if (apiKeyValid === 'false') {
                    document.getElementById('apiKeyStatus').textContent = 'Invalid Key';
                    document.getElementById('setupApiKey').textContent = 'Fix API Key';
                    document.getElementById('backupStatus').textContent = 'Invalid API Key';
                    document.getElementById('backupStatus').className = 'status-indicator status-inactive';
                } else {
                    document.getElementById('apiKeyStatus').textContent = 'Valid';
                    document.getElementById('setupApiKey').textContent = 'Update API Key';
                    document.getElementById('backupStatus').textContent = 'Active';
                    document.getElementById('backupStatus').className = 'status-indicator status-active';
                }
            } else {
                document.getElementById('removeApiKey').style.display = 'none';
                document.getElementById('apiKeyStatus').textContent = 'Not Set';
                document.getElementById('setupApiKey').textContent = 'Setup API Key';
                document.getElementById('backupStatus').textContent = 'Not Configured';
                document.getElementById('backupStatus').className = 'status-indicator status-inactive';
            }

            // Last Backup
            if (lastBackup) {
                const date = new Date(parseInt(lastBackup));
                document.getElementById('lastBackupTime').textContent = date.toLocaleString();
            } else {
                document.getElementById('lastBackupTime').textContent = 'Never';
            }

            // Changes Since Backup
            document.getElementById('changesSince').textContent = dataChanged ? 'Yes' : 'No';

            // Next Backup
            if (apiKey && lastBackup) {
                const nextBackupTime = parseInt(lastBackup) + (24 * 60 * 60 * 1000);
                const now = Date.now();
                if (dataChanged && now >= nextBackupTime) {
                    document.getElementById('nextBackup').textContent = 'Ready now';
                } else if (dataChanged) {
                    const hoursLeft = Math.ceil((nextBackupTime - now) / (60 * 60 * 1000));
                    document.getElementById('nextBackup').textContent = `In ${hoursLeft} hours`;
                } else {
                    document.getElementById('nextBackup').textContent = 'When changes made';
                }
            } else {
                document.getElementById('nextBackup').textContent = 'N/A';
            }


        }



        document.getElementById('setupApiKey').addEventListener('click', function() {
            document.getElementById('apiKeyModal').style.display = 'block';
        });
        
        document.getElementById('confirmApiKey').addEventListener('click', function() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                // Test the API key immediately
                fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey
                    },
                    body: JSON.stringify({test: true})
                }).then(response => {
                    if (response.ok) {
                        localStorage.setItem('jsonbinApiKey', apiKey);
                        localStorage.setItem('apiKeyValid', 'true');
                        document.getElementById('apiKeyModal').style.display = 'none';
                        showStatus('Success', 'API key validated and saved!');

                    } else {
                        localStorage.setItem('jsonbinApiKey', apiKey);
                        localStorage.setItem('apiKeyValid', 'false');
                        document.getElementById('apiKeyModal').style.display = 'none';
                        showStatus('Warning', 'API key saved but appears invalid. Check your key.');
                    }
                    updateBackupStatus();
                }).catch(err => {
                    localStorage.setItem('jsonbinApiKey', apiKey);
                    localStorage.setItem('apiKeyValid', 'false');
                    document.getElementById('apiKeyModal').style.display = 'none';
                    showStatus('Error', 'Could not validate API key. Check your connection.');
                    updateBackupStatus();
                });
            }
        });
        
        document.getElementById('cancelApiKey').addEventListener('click', function() {
            document.getElementById('apiKeyModal').style.display = 'none';
        });
        
        function showStatus(title, message) {
            document.getElementById('statusTitle').textContent = title;
            document.getElementById('statusMessage').textContent = message;
            document.getElementById('statusModal').style.display = 'block';
        }
        
        document.getElementById('statusOk').addEventListener('click', function() {
            document.getElementById('statusModal').style.display = 'none';
        });
        
        document.getElementById('removeApiKey').addEventListener('click', function() {
            document.getElementById('removeApiKeyModal').style.display = 'block';
        });
        
        document.getElementById('confirmRemoveApiKey').addEventListener('click', function() {
            localStorage.removeItem('jsonbinApiKey');
            localStorage.removeItem('apiKeyValid');
            document.getElementById('removeApiKeyModal').style.display = 'none';
            showStatus('Success', 'API key removed. Auto backup disabled.');
            updateBackupStatus();
        });
        
        document.getElementById('cancelRemoveApiKey').addEventListener('click', function() {
            document.getElementById('removeApiKeyModal').style.display = 'none';
        });
        
        // Close modals when clicking X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        document.getElementById('forceBackup').addEventListener('click', function() {
            const apiKey = localStorage.getItem('jsonbinApiKey');
            if (!apiKey) {
                showStatus('Warning', 'Please setup API key first');
                return;
            }

            const watchlistData = JSON.parse(localStorage.getItem('watchlistData') || '[]');
            const rankings = JSON.parse(localStorage.getItem('watchlistRankings') || '[]');
            
            const exportData = {
                watchlistData: watchlistData,
                rankings: rankings,
                timestamp: new Date().toISOString()
            };
            
            fetch('https://api.jsonbin.io/v3/b', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': apiKey
                },
                body: JSON.stringify(exportData)
            }).then(response => {
                if (response.ok) {
                    localStorage.setItem('lastAutoBackup', Date.now());
                    localStorage.removeItem('dataChanged');
                    localStorage.setItem('apiKeyValid', 'true');
                    showStatus('Success', 'Backup completed successfully!');
                    updateBackupStatus();
                } else {
                    localStorage.setItem('apiKeyValid', 'false');
                    showStatus('Error', 'Backup failed. Invalid API key.');
                    updateBackupStatus();
                }
            }).catch(err => {
                showStatus('Error', 'Backup failed. Check your connection.');
            });
        });

        document.getElementById('testConnection').addEventListener('click', function() {
            const apiKey = localStorage.getItem('jsonbinApiKey');
            if (!apiKey) {
                showStatus('Warning', 'Please setup API key first');
                return;
            }

            fetch('https://api.jsonbin.io/v3/b', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': apiKey
                },
                body: JSON.stringify({test: true})
            }).then(response => {
                if (response.ok) {
                    localStorage.setItem('apiKeyValid', 'true');
                    showStatus('Success', 'Connection successful!');

                    updateBackupStatus();
                } else {
                    localStorage.setItem('apiKeyValid', 'false');
                    showStatus('Error', 'Connection failed. Invalid API key.');
                    updateBackupStatus();
                }
            }).catch(err => {
                showStatus('Error', 'Connection failed. Check your internet.');
            });
        });

        // Update status every 30 seconds, fetch account info only on page load and after API operations
        setInterval(updateBackupStatus, 30000);
        updateBackupStatus();
        
        // Fetch account info immediately on page load
        const apiKey = localStorage.getItem('jsonbinApiKey');
        if (apiKey && localStorage.getItem('apiKeyValid') !== 'false') {
            fetchAccountInfo(apiKey);
        }
    </script>
</body>
</html>
